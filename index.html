<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StudyLog</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{--bg:#0f0f13;--surface:#17171e;--surface2:#1e1e28;--border:#2a2a38;--accent:#7c6af7;--accent2:#f76a8c;--accent3:#6af7c8;--text:#e8e8f0;--text-muted:#7a7a99;--font-body:'Noto Sans JP',sans-serif;--font-mono:'DM Mono',monospace}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:var(--font-body);min-height:100vh;padding:24px 16px}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 20%,rgba(124,106,247,.08) 0%,transparent 60%),radial-gradient(ellipse at 80% 80%,rgba(247,106,140,.06) 0%,transparent 60%);pointer-events:none;z-index:0}
.container{max-width:860px;margin:0 auto;position:relative;z-index:1}
header{display:flex;align-items:baseline;gap:12px;margin-bottom:32px}
header h1{font-family:var(--font-mono);font-size:1.6rem;font-weight:500}
header h1 span{color:var(--accent)}
header p{font-size:.8rem;color:var(--text-muted)}
.sync-badge{margin-left:auto;font-size:.7rem;padding:3px 10px;border-radius:20px;font-family:var(--font-mono);display:flex;align-items:center;gap:5px}
.sync-badge.ok{background:rgba(106,247,200,.12);color:var(--accent3);border:1px solid rgba(106,247,200,.2)}
.sync-badge.loading{background:rgba(124,106,247,.12);color:var(--accent);border:1px solid rgba(124,106,247,.2)}
.sync-badge.error{background:rgba(247,106,140,.12);color:var(--accent2);border:1px solid rgba(247,106,140,.2)}
.dot{width:6px;height:6px;border-radius:50%;background:currentColor}
.summary-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px}
.summary-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;position:relative;overflow:hidden}
.summary-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.summary-card:nth-child(1)::before{background:var(--accent)}
.summary-card:nth-child(2)::before{background:var(--accent3)}
.summary-card:nth-child(3)::before{background:var(--accent2)}
.summary-card .label{font-size:.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px}
.summary-card .value{font-family:var(--font-mono);font-size:1.8rem;font-weight:500;line-height:1}
.summary-card:nth-child(1) .value{color:var(--accent)}
.summary-card:nth-child(2) .value{color:var(--accent3)}
.summary-card:nth-child(3) .value{color:var(--accent2)}
.summary-card .sublabel{font-size:.72rem;color:var(--text-muted);margin-top:4px}
.main-grid{display:grid;grid-template-columns:1fr 1.2fr;gap:16px;margin-bottom:16px}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:14px;overflow:hidden}
.panel-header{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.panel-title{font-size:.78rem;font-weight:500;letter-spacing:.06em;text-transform:uppercase;color:var(--text-muted)}
.panel-body{padding:18px}
.form-row{display:flex;gap:10px;margin-bottom:12px}
.form-group{flex:1;display:flex;flex-direction:column;gap:5px}
label{font-size:.72rem;color:var(--text-muted);font-weight:500}
input,select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--font-body);font-size:.85rem;padding:9px 12px;outline:none;transition:border-color .2s;width:100%}
input:focus,select:focus{border-color:var(--accent)}
.btn{background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-family:var(--font-body);font-size:.85rem;font-weight:500;padding:10px 20px;transition:all .2s;white-space:nowrap}
.btn:hover{background:#9d8cf9;transform:translateY(-1px)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.chip-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
.chip{border-radius:20px;cursor:pointer;font-size:.75rem;font-weight:500;padding:4px 12px;transition:all .15s;border:1px solid transparent}
.log-list{display:flex;flex-direction:column;gap:8px;max-height:260px;overflow-y:auto}
.log-list::-webkit-scrollbar{width:4px}
.log-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.log-item{background:var(--surface2);border-radius:8px;padding:10px 14px;display:flex;align-items:center;gap:10px;animation:slideIn .25s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.log-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.log-info{flex:1;min-width:0}
.log-subject{font-size:.82rem;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.log-meta{font-size:.7rem;color:var(--text-muted);margin-top:1px}
.log-time{font-family:var(--font-mono);font-size:.85rem;font-weight:500;flex-shrink:0}
.log-delete{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:.9rem;padding:2px 4px;border-radius:4px;transition:color .15s;flex-shrink:0}
.log-delete:hover{color:var(--accent2)}
.empty-state{text-align:center;padding:32px 0;color:var(--text-muted);font-size:.82rem}
.chart-area{height:180px;display:flex;align-items:flex-end;gap:6px;padding-bottom:24px;position:relative}
.chart-area::after{content:'';position:absolute;bottom:24px;left:0;right:0;height:1px;background:var(--border)}
.bar-group{flex:1;display:flex;flex-direction:column;align-items:center;height:100%;justify-content:flex-end;position:relative}
.bar{width:100%;border-radius:4px 4px 0 0;transition:height .4s cubic-bezier(.34,1.56,.64,1);min-height:2px;position:relative}
.bar:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border);border-radius:6px;font-size:.7rem;padding:3px 8px;white-space:nowrap;color:var(--text);z-index:10}
.bar-label{font-size:.62rem;color:var(--text-muted);position:absolute;bottom:6px;width:100%;text-align:center}
.subject-breakdown{display:flex;flex-direction:column;gap:8px;max-height:220px;overflow-y:auto}
.subject-row{display:flex;align-items:center;gap:10px}
.subject-bar-wrap{flex:1;background:var(--surface2);border-radius:4px;height:6px;overflow:hidden}
.subject-bar-fill{height:100%;border-radius:4px;transition:width .5s cubic-bezier(.34,1.56,.64,1)}
.subject-name{font-size:.78rem;width:80px;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.subject-hours{font-family:var(--font-mono);font-size:.75rem;color:var(--text-muted);width:40px;text-align:right;flex-shrink:0}
.tabs{display:flex;gap:4px}
.tab-btn{background:none;border:1px solid var(--border);border-radius:6px;color:var(--text-muted);cursor:pointer;font-family:var(--font-body);font-size:.72rem;padding:4px 10px;transition:all .15s}
.tab-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
@media(max-width:600px){.main-grid{grid-template-columns:1fr}.form-row{flex-direction:column}header h1{font-size:1.3rem}}
</style>
</head>
<body>
<div class="container">
<header>
<h1>Study<span>Log</span></h1>
<p>勉強時間トラッカー</p>
<div class="sync-badge loading" id="syncBadge"><div class="dot"></div><span id="syncText">接続中...</span></div>
</header>
<div class="summary-grid">
<div class="summary-card"><div class="label">今日</div><div class="value" id="todayTotal">—</div><div class="sublabel">勉強時間</div></div>
<div class="summary-card"><div class="label">今週</div><div class="value" id="weekTotal">—</div><div class="sublabel">合計</div></div>
<div class="summary-card"><div class="label">累計</div><div class="value" id="allTotal">—</div><div class="sublabel">全期間</div></div>
</div>
<div class="main-grid">
<div class="panel">
<div class="panel-header"><span class="panel-title">記録する</span></div>
<div class="panel-body">
<div style="margin-bottom:8px"><label style="display:block;margin-bottom:6px">科目を選ぶ</label><div class="chip-row" id="chipRow"></div></div>
<div class="form-row">
<div class="form-group"><label>日付</label><input type="date" id="inputDate"></div>
<div class="form-group"><label>時間(h)</label><input type="number" id="inputHours" min="0" max="24" step="0.5" placeholder="例:1.5"></div>
</div>
<div class="form-row"><div class="form-group"><label>メモ(任意)</label><input type="text" id="inputMemo" placeholder="例:第3章まで完了"></div></div>
<button class="btn" id="addBtn" onclick="addLog()" style="width:100%">記録する</button>
<div style="margin-top:14px;display:flex;gap:8px">
<input type="text" id="newSubject" placeholder="科目を追加..." style="flex:1">
<button class="btn" onclick="addSubject()" style="padding:10px 14px">＋</button>
</div>
</div>
</div>
<div class="panel">
<div class="panel-header"><span class="panel-title">最近の記録</span></div>
<div class="panel-body" style="padding:14px"><div class="log-list" id="logList"><div class="empty-state">読み込み中...</div></div></div>
</div>
</div>
<div class="main-grid">
<div class="panel">
<div class="panel-header">
<span class="panel-title">週間グラフ</span>
<div class="tabs">
<button class="tab-btn active" onclick="setChartMode('week',this)">週</button>
<button class="tab-btn" onclick="setChartMode('month',this)">月</button>
</div>
</div>
<div class="panel-body"><div class="chart-area" id="barChart"></div></div>
</div>
<div class="panel">
<div class="panel-header"><span class="panel-title">科目別内訳</span></div>
<div class="panel-body"><div class="subject-breakdown" id="subjectBreakdown"><div class="empty-state">読み込み中...</div></div></div>
</div>
</div>
</div>
<script>
const SUPABASE_URL='https://xbbnaqqrswyrbshsvkur.supabase.co';
const SUPABASE_KEY='sb_publishable_HPna0aj9u5RwNPCnmumM8A_16wdngpN';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const COLORS=['#7c6af7','#f76a8c','#6af7c8','#f7c86a','#6aaff7','#f76ac8','#a0f76a','#f7a06a'];
let logs=[],subjects=[],selectedSubject='',chartMode='week';
const subjectColor=n=>COLORS[subjects.indexOf(n)%COLORS.length]||'#7c6af7';
const formatHours=h=>{if(h===0)return'0h';if(h<1)return Math.round(h*60)+'m';const hr=Math.floor(h),mn=Math.round((h-hr)*60);return mn>0?hr+'h'+mn+'m':hr+'h'};
const today=()=>new Date().toISOString().slice(0,10);
const setSyncStatus=(s,t)=>{document.getElementById('syncBadge').className='sync-badge '+s;document.getElementById('syncText').textContent=t};
async function loadSubjects(){
const{data}=await sb.from('study_subjects').select('name').order('id');
if(!data||!data.length){const d=['英語','数学','プログラミング','読書','資格勉強'];for(const n of d)await sb.from('study_subjects').upsert({name:n},{onConflict:'name'});subjects=d;}
else subjects=data.map(d=>d.name);
if(!selectedSubject&&subjects.length)selectedSubject=subjects[0];
renderChips();}
async function addSubject(){
const inp=document.getElementById('newSubject'),name=inp.value.trim();
if(!name||subjects.includes(name)){inp.value='';return;}
const{error}=await sb.from('study_subjects').insert({name});
if(!error){subjects.push(name);selectedSubject=name;renderChips();}
inp.value='';}
function renderChips(){
const row=document.getElementById('chipRow');row.innerHTML='';
subjects.forEach(s=>{const c=document.createElement('span');c.className='chip';c.textContent=s;const col=subjectColor(s);
if(s===selectedSubject){c.style.background=col;c.style.color='#fff';c.style.borderColor=col;}
else{c.style.background='transparent';c.style.color=col;c.style.borderColor=col;}
c.onclick=()=>{selectedSubject=s;renderChips();};row.appendChild(c);});}
async function loadLogs(){
const{data,error}=await sb.from('study_logs').select('*').order('created_at',{ascending:false}).limit(200);
if(error){setSyncStatus('error','接続エラー');return;}
logs=data||[];renderAll();}
async function addLog(){
const date=document.getElementById('inputDate').value||today();
const hours=parseFloat(document.getElementById('inputHours').value);
const memo=document.getElementById('inputMemo').value.trim();
if(!selectedSubject){alert('科目を選んでください');return;}
if(!hours||hours<=0){alert('時間を入力してください');return;}
const btn=document.getElementById('addBtn');btn.disabled=true;btn.textContent='保存中...';
const{data,error}=await sb.from('study_logs').insert({date,subject:selectedSubject,hours,memo}).select().single();
if(!error&&data){logs.unshift(data);document.getElementById('inputHours').value='';document.getElementById('inputMemo').value='';renderAll();setSyncStatus('ok','同期済み');}
else{alert('保存に失敗しました');setSyncStatus('error','エラー');}
btn.disabled=false;btn.textContent='記録する';}
async function deleteLog(id){
const{error}=await sb.from('study_logs').delete().eq('id',id);
if(!error){logs=logs.filter(l=>l.id!==id);renderAll();}}
function renderLogs(){
const list=document.getElementById('logList'),recent=logs.slice(0,30);
if(!recent.length){list.innerHTML='<div class="empty-state">まだ記録がありません</div>';return;}
list.innerHTML=recent.map(l=>`<div class="log-item"><div class="log-dot" style="background:${subjectColor(l.subject)}"></div><div class="log-info"><div class="log-subject">${l.subject}${l.memo?' — '+l.memo:''}</div><div class="log-meta">${l.date}</div></div><div class="log-time" style="color:${subjectColor(l.subject)}">${formatHours(l.hours)}</div><button class="log-delete" onclick="deleteLog(${l.id})">✕</button></div>`).join('');}
function renderSummary(){
const t=today(),now=new Date();
const todayH=logs.filter(l=>l.date===t).reduce((s,l)=>s+l.hours,0);
const diff=now.getDay()===0?6:now.getDay()-1;
const mon=new Date(now);mon.setDate(now.getDate()-diff);
const weekH=logs.filter(l=>l.date>=mon.toISOString().slice(0,10)&&l.date<=t).reduce((s,l)=>s+l.hours,0);
const allH=logs.reduce((s,l)=>s+l.hours,0);
document.getElementById('todayTotal').textContent=formatHours(todayH);
document.getElementById('weekTotal').textContent=formatHours(weekH);
document.getElementById('allTotal').textContent=formatHours(allH);}
function setChartMode(mode,btn){chartMode=mode;document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderBarChart();}
function renderBarChart(){
const chart=document.getElementById('barChart');chart.innerHTML='';
const now=new Date();let days=[];
if(chartMode==='week'){for(let i=6;i>=0;i--){const d=new Date(now);d.setDate(now.getDate()-i);days.push(d.toISOString().slice(0,10));}}
else{for(let w=3;w>=0;w--){const ws=new Date(now),we=new Date(now);ws.setDate(now.getDate()-w*7-6);we.setDate(now.getDate()-w*7);days.push({start:ws.toISOString().slice(0,10),end:we.toISOString().slice(0,10),label:`W${4-w}`});}}
const getH=d=>chartMode==='week'?logs.filter(l=>l.date===d).reduce((s,l)=>s+l.hours,0):logs.filter(l=>l.date>=d.start&&l.date<=d.end).reduce((s,l)=>s+l.hours,0);
const maxH=Math.max(...days.map(getH),1);
days.forEach(d=>{
const g=document.createElement('div');g.className='bar-group';
const totalH=getH(d);
const label=chartMode==='week'?['日','月','火','水','木','金','土'][new Date((typeof d==='string'?d:'')+'T12:00:00').getDay()]:d.label;
const bar=document.createElement('div');bar.className='bar';
bar.style.height=`${Math.max(Math.round(totalH/maxH*100),1)}%`;
bar.style.background='linear-gradient(180deg,var(--accent) 0%,#5a48d4 100%)';
bar.style.opacity=totalH>0?'1':'0.2';
bar.setAttribute('data-tip',formatHours(totalH));
const lbl=document.createElement('div');lbl.className='bar-label';lbl.textContent=label;
g.appendChild(bar);g.appendChild(lbl);chart.appendChild(g);});}
function renderSubjectBreakdown(){
const el=document.getElementById('subjectBreakdown'),totals={};
logs.forEach(l=>{totals[l.subject]=(totals[l.subject]||0)+l.hours;});
const entries=Object.entries(totals).sort((a,b)=>b[1]-a[1]);
if(!entries.length){el.innerHTML='<div class="empty-state">記録がありません</div>';return;}
const max=entries[0][1];
el.innerHTML=entries.map(([name,h])=>`<div class="subject-row"><div class="subject-name" style="color:${subjectColor(name)}">${name}</div><div class="subject-bar-wrap"><div class="subject-bar-fill" style="width:${Math.round(h/max*100)}%;background:${subjectColor(name)}"></div></div><div class="subject-hours">${formatHours(h)}</div></div>`).join('');}
function renderAll(){renderLogs();renderSummary();renderBarChart();renderSubjectBreakdown();}
document.getElementById('inputDate').value=today();
async function init(){setSyncStatus('loading','接続中...');try{await loadSubjects();await loadLogs();setSyncStatus('ok','同期済み');}catch(e){setSyncStatus('error','接続エラー');}}
init();
</script>
</body>
</html>
